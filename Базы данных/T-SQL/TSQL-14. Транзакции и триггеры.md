Подробно не разбирал, так как на текущей работе без необходимости.
# Транзакции
Транзакция - группа последовательных операций с базой данных, которая представляет собой логическую единицу работы с данными. Если транзакция выполнена успешно, все модификации данных, сделанные в течении транзакции принимаются и становятся постоянной частью базы данных. Если в результате выполнения транзакции происходят ошибки и должна быть произведена отмена или выполнен откат, все модификации данных будут отменены.
Существует 2 типа транзакций:
- неявные - каждый оператор, как Insert, Update, Delete выполняется в транзакции;
- явные - группа инструкций TSQL, начало и конец которых обзоначаются инструкциями - BEGIN TRANSACTION, COMMIT, ROLLBACK;
## Свойства транзакций (ACID)
- Атомарность (atomacity) - гарантирует, что никакая транзакция не будет зафиксирована в системе частично. Будут либо выполнены все ее подоперации, либо не выполнено ни одной. Поскольку на практике невозможно одновременно и атомарно выполнить всю последовательность операций внутри транзакции, вводится понятие отката - rollback. Если транзакция не удается полностью завершить, результаты всех её до сих пор произведенных действий будут отменены и система вернется в исходное состояние. Но мы можем устанавливать точки сохранения и откатываться к ним.
- Согласованность (consistency) - обеспечивает, что в результате выполнения транзакции база данных не будет содержать несогласованных данных. Иными словами, выполняемые транзакцией трансформации данных переводят базу данных из одного согласованного состояния в другое.
- Изолированность (isolation) - Во время выполнения транзакции параллельные транзакции не должны оказывать влияния на ее результат. Изолированность - требование дорогое, поэтому в реальных БД существуют режимы, не полностью изолирующие транзакцию (уровни изолированности). С БД могут работать большое количество пользователей. И большие обновления БД происходят в нерабочее время.
Устойчивость (durability) - в случае системной ошибки (обесточивание системы или сбои оборудования) изменения, сделанные успешно завершенной транзакцией, должны остаться сохраненными после возвращения системы в работу.

## Пример №1

BEGIN TRANSACTION
-- или Begin TRAN
UPDATE Courts SET Capasity = 4500 WHERE Id = 10

SELECT * FROM Courts
-- внесли изменения

ROLLBACK TRANSACTION

SELECT * FROM Courts
-- откатили изменения

Rollback transaction всегда работает в связке с Begin Transaction. Сам по себе он не может отменить транзакцию если не было команды начала.
Если у нас идет транзакция в транзакции, а потом Rollback, то отбрасывает обе транзакции и внешнюю и внутреннюю

## Пример №2. Подтвердить транзакцию. 
BEGIN TRAN

UPDATE Courts SET Capasity = 4000 WHERE Id = 10

SELECT * FROM Courts

COMMIT
-- транзакцию завершили

UPDATE Courts SET Capasity = 5000 WHERE Id = 10

ROLLBACK

SELECT * FROM Courts
откат будет до 4000

## Пример №3. Откатиться к определенным транзакциям

BEGIN TRAN
UPDATE Courts SET City = 'London' WHERE Id = 10

SAVE TRAN save1

	BEGIN TRAN
	UPDATE Courts SET Capasity = 1000 WHERE Id = 10

ROLLBACK TRAN save1

![[Pasted image 20240921222312.png]]
При хотя бы минимальной изолированности разные транзакции не смогут одновременно обновлять данные, это на уровне msqql решено.

![[Pasted image 20240921222623.png]]
# Триггеры
Триггер - особая разновидность хранимой процедуры, выполняемая автоматически при возникновении события на сервере базы данных.

Существуют триггеры на события DDL, DML. Триггеры часто используются для применения бизнес-правил  и обеспечения целостности данных. События триггера DML - Insert, Update, Delete.

Какая-то процедура будет вызываться в фоновом режиме при инсерте в определенную таблицу и т.д. Например при покупке товара, он должен убыть в другой таблице.

![[Pasted image 20240921225103.png]]
![[Pasted image 20240921230446.png]]