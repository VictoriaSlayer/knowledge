Правила объединения наборов
Количество и порядок столбцов должны быть одинаковыми во всех запросах.
Типы данных должны быть совместимыми.
В результирующем наборе используются имена столбцов заданные в первом запросе.
# Union
Объединение множеств - множество, содержащее в себе все элементы исходных множеств.
![[Pasted image 20240818215631.png]]

## Логика Union
Мы можем объединять все, что угодно. Должны совпадать порядок следования и количество столбцов и типы столбцов. Union исключает дублирование одинаковых записей. По логике необходимо объединять одинаковые по логическому смыслу столбцы, при этом дубликаты исключаются.
Названия столбцов будут браться по первому Select.
## Порядок столбцов
Если мы не указываем порядок столбцов, то считается, что мы вставляем все вставляемые столбцы. Поэтому рекомендуется указывать столбцы, т.к. порядок столбцов в будущем может поменяться.

INSERT Customers (Name)  VALUES
('Fryderyk Chopin');

## Несколько столбцов

select id, name from customers
union
select id, fullname from Suppliers

![[Pasted image 20240818225514.png]]
В этой ситуации Union будет выводить уникальные строки по обоим столбцам.
## Если в одной таблице нет столбца
Указываем Null или дефолтное значение:

select name, [Mobile], email from customers
union
select fullname, [Phone], null from Suppliers

select name, [Mobile], email from customers
union
select fullname, [Phone], 'No email ' from Suppliers

# Union All
Union All - получаем все записи из первой таблицы, все записи из второй таблицы.
Никакого упорядочивания, никакого отсутствия дублирования строк.

### Финт
(select name from customers
union all
select fullname from suppliers)
![[Pasted image 20240818232009.png]]
Но если мы сделаем выражение, то будет следующий результат, когда порежутся уникальные значения:
(select name from customers
union all
select fullname from suppliers)
union 
select fullname from suppliers
![[Pasted image 20240818232034.png]]
Получается мы 2 таблицы объединили с помощью Union.

# Intersect
Пересечение множеств - множество, которому принадлежат те и только те элементы, которые одновременно принадлежат всем данным множествам.
![[Pasted image 20240818232706.png]]
select name from customers
intersect
select fullname from suppliers
![[Pasted image 20240818233053.png]]
# Except
Разность двух множеств - множество, в которое входят все элементы первого множества, не входящие во второе множество.
![[Pasted image 20240818232806.png]]
select name from customers
except
select fullname from suppliers
![[Pasted image 20240818232936.png]]

# Порядок объединения наборов
Выражения в скобках.
Оператор Intersect.
Операторы Except и Union обрабатываются слева направо в соответствии с их позицией в выражении.

# Views/Представления
Views - объекты базы данных, которые всегда создаются на основе одной или более базовых таблиц или других представлений, используя информацию метаданных. Эта информация (включая имя представления и способ получения строк из базовых таблиц) - все, что сохраняется физически для представления.
В отличии от базовых таблиц, представления по умолчанию не существуют физически, т.е. их содержимое не сохраняется на диске.

## Цели использования
В качестве механизма безопасности, позволяющего пользователям обращаться к данным через представления, но не предоставляя им разрешений на непосредственный доступ к базовым таблицам.
Для скрытия подробностей сложных запросов.
Для ограничения вставляемых или обновляемых значений некоторым диапазоном.

## Создать представление

Примерный полный синтаксис

CREATE VIEW Название_представления
	(столбец1, столбец2, столбец3)
AS
    Select * from название_представления
select таблица1.столбец1, таблица1.столбец2, таблица2.столбец3
from таблица1 
join таблица2
on таблица1.id = таблица2.id

Представление можно корректно сортировать только если оно было создано при помощи команды TOP, OFFSET, FOR
Представление можно изменять при помощи команды Alter.

Если была удалена таблица на основании которой была построена вьюха, то с ней нельзя будет работать.

alter view имя_представления
with schemabinding
-- защита от удаления таблицы

## Обновление представления
Можно изменять данные базовой таблицы через представление если выполняются следующие условия:
•Любые изменения (UPDATE, INSERT и DELETE) должны ссылаться на столбцы только одной базовой таблицы.
•Изменяемые в представлении столбцы должны непосредственно ссылаться на данные столбцов базовой таблицы. Столбцы нельзя сформировать каким-либо другим образом, в том числе:
- агрегатными функциями;
- на основе вычисления.
•Предложения GROUP BY, HAVING и DISTINCT не влияют на изменяемые столбцы.
•TOP не используется с предложением WITH CHECK OPTION.

with check option - во вьюху нельзя добавить данные, которые не вяжутся с условиями выборки при помощи которых была создана вьюха
![[Pasted image 20240824002730.png]]
