[[Как работают оконки 1-98]]
# Статистика
Интересно понять место отдельного значения в ряду других - чтобы понять, насколько оно хорошее или плохое.
![[Pasted image 20251207161236.png]]
## Общее положение дел
### cume_dist()
Какой % людей получает *столько же или меньше*
![[Pasted image 20251207161846.png]]
```SQL
select name  
  ,salary  
  ,cume_dist() over (order by salary) as perc  
from employees  
order by salary, id
```

Результат передает в виде десятичных значений
![[Pasted image 20251207162457.png]]
Алгоритм работы:
- располагаем записи в порядке указанном в order by;
- находим текущую запись в общем ряду;
- считаем сколько записей меньше или равно текущей;
- делим на общее количество записей;
### percent_rank()
Какой % людей получает строго меньше, чем конкретный сотрудник?
*исключая текущую запись*

```SQL
select name  
  ,salary  
  ,round(  
  percent_rank() over (order by salary), 2  
  ) as perc  
from employees  
order by salary, id
```

![[Pasted image 20251207163039.png]]
### Сравнение с rank()
rank() - считает абсолютный ранг строки (её место относительно других строк согласно order by);
cume_dist(), percent_rank() - считают относительный ранг в % от других строк;

## Сводные значения
Статистики/сводные значения - описание набора данных одним или несколькими числами:
- Среднее арифметическое;
- медиана - значение посередине набора. Если имеется 2 срединных значения, то выбирается среднее арифметическое между ними. 
  ![[Pasted image 20251207163852.png]]
  Медиана более устойчива к выбросам
  ![[Pasted image 20251207163922.png]];
- процентили - характеризует конкретный % выборки:
  - если 25-й процентиль = Х, то у 25% элементов значение <= X;
  - если 50-й процентиль = Х, то у 50% элементов значение <= X;
  - если 75-й процентиль = Х, то у 75% элементов значение <= X;
  - если 90-й процентиль = Х, то у 90% элементов значение <= X;
  Большинство обычно характеризуют 90, 95, 99-м процентилем.
  ![[Pasted image 20251207164236.png]]
## Статистические функции
cume_dist() - процент строк, которые меньше либо равны текущей
percent_rank() - процент строк, которые строго меньше текущей
percentile_disc(N) - n-й процентиль который встречается в таблице 
percentile_cont(N) - n-й процентиль который высчитывается на основании имеющихся и выдается

cume_dist(), percent_rank() - поддерживают сортировку и секции в окне
percentile_disc(), percentile_rank() - 
Все статистические функции не поддерживают фрейпмы.

# Общее итого
Ранжирование - всевозможные рейтинги
Сравнение со смещением - соседние элементы и границы
Агрегация - количество, сумма и среднее
Скользящие агрегаты - сумма и среднее в динамике
Статистика - относительные ранги и сводные показатели

```SQL
over (
	partition by ...
	order by ...
	rows between ... and ...
)
```
*partition by* - поддерживается всеми оконными функциями и всегда необязательно. Если не указать, будет одна секция;
*order by* - поддерживается всеми оконными функциями кроме процентилей. Для функций ранжирования и смещения оно обязательно, для агрегации нет. Если не указать order by для функции агрегации - она посчитает обычный агрегат. Если указать - скользящий.
*Фрейм* поддерживается только следующими функциями:
- first_value(), last_value(), nth_value();
- функции агрегации;
Остальные функции не поддерживают фреймы.

## Функции ранжирования
![[Pasted image 20251211205346.png]]
## Функции смещения
![[Pasted image 20251211205416.png]]
## Функции агрегации
![[Pasted image 20251211205435.png]]
## Функции статистики
![[Pasted image 20251211205455.png]]